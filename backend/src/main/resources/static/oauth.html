<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OAuth - SaviaU</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; }
    .wrap { max-width: 720px; margin: 24px auto; padding: 16px; }
    .card { border: 1px solid #8884; border-radius: 8px; padding: 12px; margin-top: 16px; }
    .ok { color: #0a0; }
    .err { color: #c00; white-space: pre-wrap; }
    label { font-weight: 600; }
    input, button { font: inherit; padding: 8px 10px; }
    .row { display: grid; gap: 8px; margin: 8px 0; }
    .actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    a { color: inherit; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Finalizando Login con Google</h1>

    <div id="msg" class="card">Procesando...</div>

    <div class="card" id="onboardCard" style="display:none;">
      <h2 style="margin:0 0 8px; font-size:16px;">Completa tu perfil</h2>
      <form id="onboardForm">
        <div class="row">
          <label for="fullName">Nombre y apellido</label>
          <input id="fullName" name="fullName" type="text" placeholder="Ej: Juan Pérez" required />
        </div>
        <div class="row">
          <label for="carrera">Carrera</label>
          <input id="carrera" name="carrera" type="text" placeholder="Ing. Sistemas" />
        </div>
        <div class="row">
          <label for="universidad">Universidad</label>
          <input id="universidad" name="universidad" type="text" placeholder="Universidad X" />
        </div>
        <div class="row">
          <label for="semestre">Semestre</label>
          <input id="semestre" name="semestre" type="number" min="1" max="20" placeholder="5" required />
        </div>
        <div class="actions">
          <button type="submit">Guardar perfil</button>
          <a href="/login.html">Volver al login</a>
        </div>
      </form>
      <div id="onboardMsg" style="opacity:.85"></div>
    </div>

    <p><a href="/login.html">Volver al login</a></p>
  </div>

  <script>
    let ACCESS_TOKEN = '';

    function parseHash() {
      const h = (window.location.hash || '').replace(/^#/, '');
      const params = new URLSearchParams(h);
      const accessToken = params.get('access_token');
      const refreshToken = params.get('refresh_token');
      const error = params.get('error');
      return { accessToken, refreshToken, error };
    }

    async function finish() {
      const msg = document.getElementById('msg');
      const onboardCard = document.getElementById('onboardCard');
      const { accessToken, refreshToken, error } = parseHash();
      if (error) {
        msg.className = 'card err';
        msg.textContent = 'Error de OAuth: ' + error;
        return;
      }
      if (!accessToken) {
        msg.className = 'card err';
        msg.textContent = 'No se encontró access_token en el fragmento de la URL.';
        return;
      }
      ACCESS_TOKEN = accessToken;
      try {
        const resp = await fetch('/api/auth/google/finish', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accessToken, refreshToken })
        });
        if (!resp.ok) {
          const text = await resp.text();
          msg.className = 'card err';
          msg.textContent = 'Error al finalizar login: ' + (text || `HTTP ${resp.status}`);
          return;
        }
        const data = await resp.json();
        // Guarda tokens si quieres
        try { localStorage.setItem('accessToken', data.accessToken || ''); } catch {}
        try { localStorage.setItem('refreshToken', data.refreshToken || ''); } catch {}
        try { localStorage.setItem('appToken', data.appToken || ''); } catch {}
        const user = data?.user || {};
        msg.className = 'card ok';
        msg.innerHTML = `
          <div><strong>Login OK</strong></div>
          <div>Usuario: <code>${user.email || ''}</code></div>
          <div>ID: <code>${user.id || ''}</code></div>
        `;
        // Mostrar formulario de onboarding
        onboardCard.style.display = 'block';
      } catch (e) {
        msg.className = 'card err';
        msg.textContent = e?.message || String(e);
      }
    }

    document.getElementById('onboardForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const onboardMsg = document.getElementById('onboardMsg');
      onboardMsg.textContent = 'Guardando...';
      const fullName = document.getElementById('fullName').value.trim();
      const carrera = document.getElementById('carrera').value.trim();
      const universidad = document.getElementById('universidad').value.trim();
      const semestreStr = document.getElementById('semestre').value.trim();
      const semestre = semestreStr ? Number(semestreStr) : null;
      if (!Number.isInteger(semestre) || semestre < 1 || semestre > 20) {
        onboardMsg.textContent = 'El semestre debe ser un número entre 1 y 20.';
        return;
      }
      try {
        const resp = await fetch('/api/auth/onboard', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accessToken: ACCESS_TOKEN, fullName, carrera, universidad, semestre })
        });
        const text = await resp.text();
        onboardMsg.textContent = resp.ok ? 'Perfil actualizado correctamente.' : (text || `HTTP ${resp.status}`);
      } catch (err) {
        onboardMsg.textContent = err?.message || String(err);
      }
    });

    finish();
  </script>
</body>
</html>
